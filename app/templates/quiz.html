<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz - DSVV Quiz System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      body {
        font-family: "Poppins", sans-serif;
      }
      .question-text {
        font-size: 1.5rem;
        font-weight: 600;
      }
      .option-text {
        font-size: 1.2rem;
      }
      .correct-answer {
        border: 3px solid #10b981;
        background-color: #ecfdf5;
      }
      .wrong-answer {
        border: 3px solid #ef4444;
        background-color: #fef2f2;
      }
      .show-answer {
        border: 3px solid #3b82f6;
        background-color: #eff6ff;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }
      .time-warning {
        animation: pulse 1s infinite;
        background-color: #fef3c7;
        border: 2px solid #f59e0b;
        color: #92400e;
      }
      .time-critical {
        animation: pulse 0.5s infinite;
        background-color: #fee2e2;
        border: 2px solid #ef4444;
        color: #991b1b;
      }
      .question-status-correct {
        background-color: #10b981 !important;
        color: white !important;
      }
      .question-status-wrong {
        background-color: #ef4444 !important;
        color: white !important;
      }
      .question-status-skipped {
        background-color: #9ca3af !important;
        color: white !important;
      }
      .question-status-current {
        border: 2px solid #3b82f6 !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
      }
      .option-disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      .timer-container {
        transition: all 0.3s ease;
      }

      /* Enhanced Fullscreen and Anti-cheating Styles */
      #fullscreen-warning {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        color: white;
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
        text-align: center;
        padding: 20px;
      }

      #fullscreen-warning h2 {
        font-size: 2rem;
        margin-bottom: 20px;
        color: #ef4444;
      }

      #fullscreen-warning p {
        font-size: 1.2rem;
        margin-bottom: 10px;
        line-height: 1.5;
      }

      /* Tab switching warning */
      #tab-warning {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        color: white;
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        flex-direction: column;
        text-align: center;
        padding: 20px;
      }

      #tab-warning h2 {
        font-size: 2rem;
        margin-bottom: 20px;
        color: #ef4444;
      }

      #tab-warning p {
        font-size: 1.2rem;
        margin-bottom: 10px;
        line-height: 1.5;
      }

      #violation-counter {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ef4444;
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        z-index: 10001;
        display: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      /* Blocked user modal */
      #blocked-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        color: white;
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10002;
        flex-direction: column;
        text-align: center;
        padding: 20px;
      }

      /* Initial Loading Modal */
      #initial-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        flex-direction: column;
        text-align: center;
        padding: 20px;
      }

      #initial-loading h2 {
        font-size: 2rem;
        margin-bottom: 20px;
        color: #3b82f6;
      }

      #initial-loading p {
        font-size: 1.2rem;
        margin-bottom: 10px;
        line-height: 1.5;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* AI Status Panel */
      #ai-status-panel {
        position: fixed;
        top: 20px;
        left: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        padding: 16px;
        z-index: 1000;
        min-width: 200px;
        display: none;
        border: 2px solid #e5e7eb;
      }

      #ai-status-panel h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
      }

      .ai-status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.875rem;
      }

      .ai-status-label {
        color: #6b7280;
      }

      .ai-status-value {
        font-weight: 500;
      }

      .status-normal {
        color: #10b981;
      }

      .status-warning {
        color: #f59e0b;
      }

      .status-critical {
        color: #ef4444;
        animation: pulse 1s infinite;
      }

      #ai-warning {
        margin-top: 12px;
        padding: 8px 12px;
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 6px;
        font-size: 0.75rem;
        color: #92400e;
        display: none;
      }

      /* Notification Toast System */
      #notification-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10003;
        transition: all 0.3s ease-in-out;
        transform: translateX(100%);
        display: none;
      }

      #notification-toast.show {
        transform: translateX(0);
      }

      .toast-warning {
        border-left-color: #f59e0b;
      }
      .toast-critical {
        border-left-color: #ef4444;
      }
      .toast-info {
        border-left-color: #3b82f6;
      }

      /* Prevent text selection and copying */
      .no-select {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      /* Disable right-click context menu */
      body {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      /* Main content initially hidden */
      #quiz-content {
        display: none;
      }
    </style>
  </head>
  <body class="bg-gray-100 no-select">
    <!-- Initial Loading Modal -->
    <div id="initial-loading">
      <div class="bg-white text-gray-800 rounded-2xl p-8 max-w-md mx-auto">
        <div class="text-blue-500 text-4xl mb-4">
          <i class="fas fa-robot"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-4">
          Starting Quiz Session
        </h2>
        <p class="text-gray-600 mb-4" id="loading-message">
          Initializing security measures...
        </p>
        <div class="loading-spinner"></div>
        <div
          class="mt-4 p-4 bg-blue-50 border border-blue-300 rounded-lg text-sm"
        >
          <p class="font-medium text-blue-800 mb-2">Please wait while we:</p>
          <ul class="text-blue-700 space-y-1 list-disc list-inside">
            <li>Enable fullscreen mode</li>
            <li>Initialize AI proctoring</li>
            <li>Load quiz questions</li>
            <li>Start security monitoring</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- AI Monitoring Status Panel -->
    <div id="ai-status-panel">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-800 flex items-center">
          <i class="fas fa-robot mr-2 text-blue-500"></i>AI Monitoring
        </h3>
        <span
          id="ai-status-indicator"
          class="w-3 h-3 rounded-full bg-green-500"
        ></span>
      </div>
      <div class="space-y-2">
        <div class="ai-status-item">
          <span class="ai-status-label">Face Detection:</span>
          <span id="face-status" class="ai-status-value status-normal"
            >Active</span
          >
        </div>
        <div class="ai-status-item">
          <span class="ai-status-label">Violations:</span>
          <span id="violation-count" class="ai-status-value status-normal"
            >0</span
          >
        </div>
        <div class="ai-status-item">
          <span class="ai-status-label">Status:</span>
          <span id="monitoring-status" class="ai-status-value status-normal"
            >Normal</span
          >
        </div>
      </div>
      <div
        id="ai-warning"
        class="mt-3 p-2 bg-yellow-100 border border-yellow-400 rounded text-yellow-700 text-xs hidden"
      >
        <i class="fas fa-exclamation-triangle mr-1"></i>
        <span id="warning-message"></span>
      </div>
    </div>

    <!-- Notification Toast System -->
    <div id="notification-toast" class="hidden">
      <div
        class="bg-white rounded-lg shadow-lg border-l-4 p-4 max-w-sm toast-warning"
      >
        <div class="flex items-start">
          <div id="toast-icon" class="flex-shrink-0 mr-3">
            <i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>
          </div>
          <div class="flex-1">
            <h4 id="toast-title" class="font-semibold text-gray-800">
              Proctoring Alert
            </h4>
            <p id="toast-message" class="text-sm text-gray-600 mt-1"></p>
            <p id="toast-time" class="text-xs text-gray-500 mt-2"></p>
          </div>
          <button
            onclick="hideNotification()"
            class="flex-shrink-0 ml-4 text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Blocked User Modal -->
    <div id="blocked-modal">
      <div class="bg-white text-gray-800 rounded-2xl p-8 max-w-md mx-auto">
        <div class="text-red-500 text-4xl mb-4">
          <i class="fas fa-ban"></i>
        </div>
        <h2 class="text-2xl font-bold text-red-600 mb-4">Account Blocked</h2>
        <p class="text-lg text-gray-700 mb-4">
          Your account has been temporarily blocked from participating in
          quizzes.
        </p>
        <p class="text-gray-600 mb-6">
          Please contact the administrator for more information.
        </p>
        <button
          onclick="redirectToDashboard()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors w-full"
        >
          Return to Dashboard
        </button>
      </div>
    </div>

    <!-- Violation Counter -->
    <div id="violation-counter">
      <i class="fas fa-exclamation-triangle mr-2"></i>
      Violations: <span id="violation-count-display">0</span>/10
    </div>

    <!-- Fullscreen Warning -->
    <div id="fullscreen-warning">
      <div class="bg-white text-gray-800 rounded-2xl p-8 max-w-md mx-auto">
        <div class="text-yellow-500 text-4xl mb-4">
          <i class="fas fa-expand"></i>
        </div>
        <h2 class="text-2xl font-bold text-yellow-600 mb-4">
          Fullscreen Required
        </h2>
        <p class="text-lg text-gray-700 mb-4">
          Fullscreen mode is required for this quiz. Please enable fullscreen to
          continue.
        </p>
        <button
          id="enable-fullscreen"
          class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors w-full"
        >
          Enable Fullscreen
        </button>
      </div>
    </div>

    <!-- Tab Switching Warning -->
    <div id="tab-warning">
      <div class="bg-white text-gray-800 rounded-2xl p-8 max-w-md mx-auto">
        <div class="text-red-500 text-4xl mb-4">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h2 class="text-2xl font-bold text-red-600 mb-4">
          Warning: Violation Detected
        </h2>
        <p id="violation-message" class="text-lg text-gray-700 mb-4"></p>
        <p class="text-gray-600 mb-6" id="tab-warning-countdown">
          Returning to quiz in <span id="countdown">10</span> seconds...
        </p>
        <button
          id="return-to-quiz"
          class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors w-full"
        >
          Return to Quiz Now
        </button>
      </div>
    </div>

    <!-- Main Quiz Content (initially hidden) -->
    <div id="quiz-content" class="min-h-screen flex flex-col">
      <!-- Navigation Bar -->
      <nav class="bg-gradient-to-r from-blue-700 to-blue-800 shadow-lg p-4">
        <div
          class="container mx-auto flex flex-col md:flex-row justify-between items-center"
        >
          <div class="flex items-center mb-4 md:mb-0">
            <img
              src="/static/images/dsvvlogo.png"
              alt="DSVV Logo"
              class="h-24 mr-4 float"
            />
            <span class="text-white font-bold text-lg">Quiz Session</span>
          </div>

          <div class="flex flex-wrap justify-center gap-2 md:gap-4">
            <a
              href="{{ url_for('auth.logout') }}"
              class="text-white hover:bg-red-500 px-3 py-1 rounded transition-all"
            >
              Exit Quiz
            </a>
          </div>

          {% if user %}
          <div class="mt-4 md:mt-0 text-white text-sm md:text-base">
            <span class="font-medium"
              >{{ user.name }} ({{ user.scholar_id }})</span
            >
          </div>
          {% endif %}
        </div>
      </nav>

      <!-- Main Content -->
      <div class="container mx-auto mt-8 p-4 flex-grow">
        <!-- Timer -->
        <div class="max-w-4xl mx-auto mb-6">
          <div
            id="time-display"
            class="timer-container bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg text-center text-xl font-bold"
          >
            <i class="fas fa-clock mr-2"></i>
            Time Remaining: <span id="time-left-minutes">10</span>:<span
              id="time-left-seconds"
              >00</span
            >
          </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
          <!-- Question Navigation Panel -->
          <div class="w-full lg:w-1/4 bg-white p-4 rounded-xl shadow-lg h-fit">
            <h3
              class="text-lg font-semibold text-blue-800 mb-4 flex items-center"
            >
              <i class="fas fa-list-ol mr-2"></i> Questions
            </h3>
            <div class="grid grid-cols-5 gap-2" id="question-navigation">
              <!-- Question numbers will be populated here -->
            </div>

            <div class="mt-6 pt-4 border-t border-gray-200">
              <div class="flex items-center mb-2">
                <div class="w-4 h-4 rounded-full bg-green-500 mr-2"></div>
                <span class="text-sm">Answered Correctly</span>
              </div>
              <div class="flex items-center mb-2">
                <div class="w-4 h-4 rounded-full bg-red-500 mr-2"></div>
                <span class="text-sm">Answered Incorrectly</span>
              </div>
              <div class="flex items-center mb-2">
                <div class="w-4 h-4 rounded-full bg-gray-400 mr-2"></div>
                <span class="text-sm">Skipped</span>
              </div>
              <div class="flex items-center">
                <div
                  class="w-4 h-4 rounded-full border-2 border-blue-500 mr-2"
                ></div>
                <span class="text-sm">Current Question</span>
              </div>
            </div>
          </div>

          <!-- Question Content -->
          <div
            class="w-full lg:w-3/4 bg-white p-8 rounded-xl shadow-lg animate-fade-in"
          >
            <div id="quiz-container" class="mb-8">
              <!-- Question and options will be loaded here by JavaScript -->
            </div>

            <div id="answer-feedback" class="hidden mb-6 p-4 rounded-lg">
              <!-- Correct answer will be shown here -->
            </div>

            <div class="flex flex-wrap gap-3 justify-between">
              <button
                id="skip-question"
                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300 flex items-center"
              >
                <i class="fas fa-forward mr-2"></i> Skip
              </button>

              <div class="flex gap-3">
                <button
                  id="submit-answer"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300 flex items-center"
                >
                  <i class="fas fa-paper-plane mr-2"></i> Submit Answer
                </button>
                <button
                  id="next-question"
                  class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300 hidden flex items-center"
                >
                  <i class="fas fa-arrow-right mr-2"></i> Next Question
                </button>
                <button
                  id="finish-question"
                  class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-300 hidden flex items-center"
                >
                  <i class="fas fa-flag-checkered mr-2"></i> Finish Quiz
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let questions = [];
      let currentQuestionIndex = 0;
      let selectedAnswer = null;
      let answerSubmitted = false;
      let quizSubmitted = false;
      let questionStatuses = [];
      let userAnswers = {};
      let timerInterval;
      let fullscreenEnabled = false;
      let tabSwitchCount = 0;
      let maxTabSwitches = 10; // Increased for notifications
      let visibilityChangeHandler;
      let autoSubmitTimeout;
      let isBlocked = false;
      let tabWarningCountdownInterval;

      // === AI MONITORING ===
      let aiMonitoringActive = false;
      let aiStatusCheckInterval;
      let lastViolationCount = 0;
      let quizId = "{{ quiz_id }}";

      // === NOTIFICATION SYSTEM ===
      let notificationQueue = [];
      let isShowingNotification = false;
      let shownNotificationIds = new Set();

      // Enhanced fullscreen functions
      function enterFullscreen() {
        const elem = document.documentElement;
        return new Promise((resolve, reject) => {
          if (checkFullscreen()) {
            resolve();
            return;
          }

          const requestFullscreen =
            elem.requestFullscreen ||
            elem.webkitRequestFullscreen ||
            elem.msRequestFullscreen;

          if (!requestFullscreen) {
            reject(new Error("Fullscreen API not supported"));
            return;
          }

          const fullscreenPromise = requestFullscreen.call(elem);

          if (fullscreenPromise) {
            fullscreenPromise.then(resolve).catch(reject);
          } else {
            const checkFullscreenInterval = setInterval(() => {
              if (checkFullscreen()) {
                clearInterval(checkFullscreenInterval);
                resolve();
              }
            }, 100);

            setTimeout(() => {
              clearInterval(checkFullscreenInterval);
              reject(new Error("Fullscreen request timed out"));
            }, 3000);
          }
        });
      }

      function exitFullscreen() {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }

      function checkFullscreen() {
        return !!(
          document.fullscreenElement ||
          document.webkitFullscreenElement ||
          document.msFullscreenElement
        );
      }

      function showFullscreenWarning() {
        document.getElementById("fullscreen-warning").style.display = "flex";
      }

      function hideFullscreenWarning() {
        document.getElementById("fullscreen-warning").style.display = "none";
      }

      // AI Monitoring Functions
      async function initializeAIMonitoring() {
        try {
          updateLoadingMessage("Initializing AI proctoring...");
          await new Promise((resolve) => setTimeout(resolve, 1000));

          const res = await fetch("/api/ai_monitoring/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ quiz_id: quizId }),
          });

          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const data = await res.json();

          if (data.success) {
            aiMonitoringActive = true;
            showAIStatusPanel();
            startAIStatusMonitoring();
            console.log("AI monitoring started successfully");
            return true;
          } else {
            throw new Error(data.error || "Failed to start AI monitoring");
          }
        } catch (err) {
          console.error("AI Monitoring error:", err);
          updateLoadingMessage(
            "AI monitoring unavailable - continuing without proctoring"
          );
          return false;
        }
      }

      function showAIStatusPanel() {
        document.getElementById("ai-status-panel").style.display = "block";
      }

      function startAIStatusMonitoring() {
        aiStatusCheckInterval = setInterval(async () => {
          if (!aiMonitoringActive || quizSubmitted) {
            clearInterval(aiStatusCheckInterval);
            return;
          }
          try {
            const res = await fetch("/api/ai_monitoring/status");
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }

            const data = await res.json();
            if (data.success) {
              updateAIStatusPanel(data.status);

              // Check for new notifications
              if (
                data.status.active_notifications &&
                data.status.active_notifications.length > 0
              ) {
                const newNotifications =
                  data.status.active_notifications.filter(
                    (notification) =>
                      !shownNotificationIds.has(notification.violation_id)
                  );

                newNotifications.forEach((notification) => {
                  showNotification(
                    notification.type,
                    notification.description,
                    notification.severity || "warning"
                  );
                  shownNotificationIds.add(notification.violation_id);
                });
              }

              // Update violation count display
              if (
                data.status.violation_summary.total_violations >
                lastViolationCount
              ) {
                lastViolationCount =
                  data.status.violation_summary.total_violations;
                updateViolationCounter();
              }
            }
          } catch (e) {
            console.error("AI status check error:", e);
          }
        }, 3000);
      }

      function updateAIStatusPanel(status) {
        document.getElementById("violation-count").textContent =
          status.violation_summary.total_violations;
        const recent = status.violation_summary.violations.slice(0, 3);
        const indicator = document.getElementById("ai-status-indicator");
        const warning = document.getElementById("ai-warning");
        const msg = document.getElementById("warning-message");

        if (recent.length > 0) {
          indicator.className =
            "w-3 h-3 rounded-full bg-yellow-500 animate-pulse";
          document.getElementById("monitoring-status").textContent = "Warning";
          document.getElementById("monitoring-status").className =
            "ai-status-value status-warning";
          msg.textContent = recent[0].description || "Suspicious activity";
          warning.style.display = "block";
        } else {
          indicator.className = "w-3 h-3 rounded-full bg-green-500";
          document.getElementById("monitoring-status").textContent = "Normal";
          document.getElementById("monitoring-status").className =
            "ai-status-value status-normal";
          warning.style.display = "none";
        }
      }

      // Notification System Functions
      function showNotification(type, message, severity = "warning") {
        const notification = {
          type,
          message,
          severity,
          timestamp: new Date(),
        };

        notificationQueue.push(notification);
        processNotificationQueue();
      }

      function processNotificationQueue() {
        if (isShowingNotification || notificationQueue.length === 0) return;

        isShowingNotification = true;
        const notification = notificationQueue.shift();
        displayNotification(notification);
      }

      function displayNotification(notification) {
        const toast = document.getElementById("notification-toast");
        const toastIcon = document.getElementById("toast-icon");
        const toastTitle = document.getElementById("toast-title");
        const toastMessage = document.getElementById("toast-message");
        const toastTime = document.getElementById("toast-time");

        // Set content
        toastTitle.textContent = getNotificationTitle(notification.type);
        toastMessage.textContent = notification.message;
        toastTime.textContent = notification.timestamp.toLocaleTimeString();

        // Set styling based on severity
        toast.className = toast.className.replace(/toast-\w+/g, "");
        toast.classList.add(`toast-${notification.severity}`);

        // Set icon
        let iconClass = "fas fa-exclamation-triangle";
        let iconColor = "text-yellow-500";

        if (notification.severity === "critical") {
          iconClass = "fas fa-exclamation-circle";
          iconColor = "text-red-500";
        } else if (notification.severity === "info") {
          iconClass = "fas fa-info-circle";
          iconColor = "text-blue-500";
        }

        toastIcon.innerHTML = `<i class="${iconClass} ${iconColor} text-xl"></i>`;

        // Show toast
        toast.style.display = "block";
        setTimeout(() => {
          toast.classList.add("show");
        }, 10);

        // Auto-hide after 5 seconds
        setTimeout(() => {
          hideNotification();
        }, 5000);
      }

      function hideNotification() {
        const toast = document.getElementById("notification-toast");
        toast.classList.remove("show");
        setTimeout(() => {
          toast.style.display = "none";
          isShowingNotification = false;
          processNotificationQueue();
        }, 300);
      }

      function getNotificationTitle(violationType) {
        const titles = {
          multiple_faces: "Multiple Faces Detected",
          face_not_visible: "Face Not Visible",
          head_turn: "Suspicious Head Movement",
          looking_down: "Looking Away From Screen",
          gaze_left: "Looking to the Left",
          gaze_right: "Looking to the Right",
          suspicious_object: "Unauthorized Object Detected",
          prolonged_face_absence: "Face Not Detected",
          tab_switch: "Tab Switch Detected",
        };

        return titles[violationType] || "Proctoring Alert";
      }

      function updateLoadingMessage(message) {
        const loadingMessage = document.getElementById("loading-message");
        if (loadingMessage) {
          loadingMessage.textContent = message;
        }
      }

      // Enhanced visibility tracking with focus/blur detection
      function setupVisibilityTracking() {
        let hidden, visibilityChange;

        if (typeof document.hidden !== "undefined") {
          hidden = "hidden";
          visibilityChange = "visibilitychange";
        } else if (typeof document.msHidden !== "undefined") {
          hidden = "msHidden";
          visibilityChange = "msvisibilitychange";
        } else if (typeof document.webkitHidden !== "undefined") {
          hidden = "webkitHidden";
          visibilityChange = "webkitvisibilitychange";
        }

        // Handle visibility changes (tab switching)
        visibilityChangeHandler = function () {
          if (document[hidden] && !quizSubmitted && !isBlocked) {
            handleViolation("tab_switch");
          }
        };

        // Handle window focus/blur (alt-tab, other applications)
        window.addEventListener("blur", function () {
          if (!quizSubmitted && !isBlocked) {
            handleViolation("window_switch");
          }
        });

        window.addEventListener("focus", function () {
          if (!quizSubmitted && !isBlocked) {
            if (tabSwitchCount > 0) {
              showTabWarning(tabSwitchCount >= maxTabSwitches);
            }
          }
        });

        if (visibilityChange) {
          document.addEventListener(
            visibilityChange,
            visibilityChangeHandler,
            false
          );
        }
      }

      function removeVisibilityTracking() {
        let visibilityChange;

        if (typeof document.hidden !== "undefined") {
          visibilityChange = "visibilitychange";
        } else if (typeof document.msHidden !== "undefined") {
          visibilityChange = "msvisibilitychange";
        } else if (typeof document.webkitHidden !== "undefined") {
          visibilityChange = "webkitvisibilitychange";
        }

        if (visibilityChange && visibilityChangeHandler) {
          document.removeEventListener(
            visibilityChange,
            visibilityChangeHandler,
            false
          );
        }

        window.removeEventListener("blur", handleViolation);
        window.removeEventListener("focus", handleViolation);
      }

      function showViolationCounter() {
        const counter = document.getElementById("violation-counter");
        const count = document.getElementById("violation-count-display");
        count.textContent = tabSwitchCount;
        counter.style.display = "block";
      }

      function updateViolationCounter() {
        const count = document.getElementById("violation-count-display");
        count.textContent = tabSwitchCount;
      }

      function showTabWarning(isFinalWarning = false) {
        const tabWarning = document.getElementById("tab-warning");
        const violationMessage = document.getElementById("violation-message");
        const returnToQuizBtn = document.getElementById("return-to-quiz");

        if (isFinalWarning) {
          violationMessage.innerHTML = `<strong style="color: #EF4444">FINAL WARNING! Further violations may result in quiz termination.</strong>`;
        } else {
          violationMessage.textContent = `Switching tabs or applications is not allowed. Violation ${tabSwitchCount} of ${maxTabSwitches}.`;
        }

        tabWarning.style.display = "flex";

        let countdown = isFinalWarning ? 5 : 10;
        const countdownElement = document.getElementById("countdown");
        countdownElement.textContent = countdown;

        // Clear any existing countdown interval
        if (tabWarningCountdownInterval) {
          clearInterval(tabWarningCountdownInterval);
        }

        tabWarningCountdownInterval = setInterval(() => {
          countdown--;
          countdownElement.textContent = countdown;

          if (countdown <= 0) {
            clearInterval(tabWarningCountdownInterval);
            hideTabWarning();
          }
        }, 1000);

        // Update button event listener
        returnToQuizBtn.onclick = function () {
          clearInterval(tabWarningCountdownInterval);
          hideTabWarning();
        };
      }

      function hideTabWarning() {
        const tabWarning = document.getElementById("tab-warning");
        if (tabWarningCountdownInterval) {
          clearInterval(tabWarningCountdownInterval);
          tabWarningCountdownInterval = null;
        }
        tabWarning.style.display = "none";
      }

      function handleViolation(type) {
        if (quizSubmitted || isBlocked) return;

        // Clear any existing auto-submit timeout to prevent multiple timers
        if (autoSubmitTimeout) {
          clearTimeout(autoSubmitTimeout);
          autoSubmitTimeout = null;
        }

        tabSwitchCount++;
        updateViolationCounter();

        console.log(
          `Violation detected (${type}): ${tabSwitchCount}/${maxTabSwitches}`
        );

        // Show notification instead of blocking immediately
        showNotification(
          "tab_switch",
          `Tab switching detected (${tabSwitchCount}/${maxTabSwitches}). Continued violations may result in quiz termination.`,
          "warning"
        );

        if (tabSwitchCount >= maxTabSwitches) {
          // Only show final warning, don't auto-submit immediately
          showNotification(
            "tab_switch",
            "FINAL WARNING! Further violations will result in quiz termination.",
            "critical"
          );
          showTabWarning(true);
        } else if (tabSwitchCount === 1) {
          // First violation - show counter and warning
          showViolationCounter();
          showTabWarning(false);
        } else {
          // Subsequent violations
          showTabWarning(false);
        }
      }

      function showBlockedModal() {
        document.getElementById("blocked-modal").style.display = "flex";
        isBlocked = true;

        // Clear any ongoing intervals
        clearInterval(timerInterval);
        if (autoSubmitTimeout) clearTimeout(autoSubmitTimeout);
        if (tabWarningCountdownInterval)
          clearInterval(tabWarningCountdownInterval);

        // Remove event listeners
        removeVisibilityTracking();
      }

      function redirectToDashboard() {
        window.location.href = "{{ url_for('student.student_dashboard') }}";
      }

      // Check if user is blocked
      async function checkIfBlocked() {
        try {
          const response = await fetch("/api/check_blocked");
          const data = await response.json();
          if (data.blocked) {
            showBlockedModal();
            return true;
          }
          return false;
        } catch (error) {
          console.error("Error checking blocked status:", error);
          return false;
        }
      }

      // Check if quiz already attempted
      async function checkQuizAttempt() {
        try {
          const response = await fetch("/api/check_quiz_attempt");
          const data = await response.json();
          if (data.attempted) {
            alert(
              "You have already attempted this quiz. You cannot re-attempt."
            );
            window.location.href = "{{ url_for('student.student_dashboard') }}";
            return true;
          }
          return false;
        } catch (error) {
          console.error("Error checking quiz attempt:", error);
          return false;
        }
      }

      // Quiz functions
      function initializeQuestionNavigation() {
        const questionNavigation = document.getElementById(
          "question-navigation"
        );
        if (!questionNavigation) return;

        questionNavigation.innerHTML = "";
        questionStatuses = new Array(questions.length).fill(null);
        userAnswers = {};

        questions.forEach((_, index) => {
          const questionButton = document.createElement("button");
          questionButton.className =
            "w-8 h-8 rounded-full flex items-center justify-center bg-gray-200 text-gray-700 font-medium transition-all";
          questionButton.textContent = index + 1;
          questionButton.addEventListener("click", () => {
            if (index !== currentQuestionIndex && !answerSubmitted) {
              navigateToQuestion(index);
            }
          });

          if (index === currentQuestionIndex) {
            questionButton.classList.add("question-status-current");
          }

          questionNavigation.appendChild(questionButton);
        });
      }

      function updateQuestionStatus(index, status) {
        const questionNavigation = document.getElementById(
          "question-navigation"
        );
        if (!questionNavigation) return;

        const questionButtons = questionNavigation.querySelectorAll("button");
        if (index < questionButtons.length) {
          questionButtons[index].classList.remove(
            "question-status-correct",
            "question-status-wrong",
            "question-status-skipped",
            "bg-gray-200",
            "text-gray-700"
          );

          if (status === "correct") {
            questionButtons[index].classList.add("question-status-correct");
          } else if (status === "wrong") {
            questionButtons[index].classList.add("question-status-wrong");
          } else if (status === "skipped") {
            questionButtons[index].classList.add("question-status-skipped");
          } else {
            questionButtons[index].classList.add(
              "bg-gray-200",
              "text-gray-700"
            );
          }

          if (index === currentQuestionIndex) {
            questionButtons[index].classList.add("question-status-current");
          } else {
            questionButtons[index].classList.remove("question-status-current");
          }
        }
      }

      function navigateToQuestion(index) {
        if (index >= 0 && index < questions.length) {
          currentQuestionIndex = index;
          loadQuestion(questions[currentQuestionIndex]);

          const questionNavigation = document.getElementById(
            "question-navigation"
          );
          if (questionNavigation) {
            const questionButtons =
              questionNavigation.querySelectorAll("button");
            questionButtons.forEach((btn, i) => {
              btn.classList.remove("question-status-current");
              if (i === currentQuestionIndex) {
                btn.classList.add("question-status-current");
              }
            });
          }
        }
      }

      function loadQuestion(question) {
        const quizContainer = document.getElementById("quiz-container");
        const answerFeedback = document.getElementById("answer-feedback");
        const submitButton = document.getElementById("submit-answer");
        const skipButton = document.getElementById("skip-question");
        const nextButton = document.getElementById("next-question");
        const finishButton = document.getElementById("finish-question");

        if (!quizContainer) return;

        answerSubmitted = false;
        selectedAnswer = null;
        if (answerFeedback) answerFeedback.classList.add("hidden");

        const questionIndex = currentQuestionIndex;
        const isAnswered =
          questionStatuses[questionIndex] === "correct" ||
          questionStatuses[questionIndex] === "wrong";
        const isSkipped = questionStatuses[questionIndex] === "skipped";

        if (isAnswered) {
          if (submitButton) submitButton.classList.add("hidden");
          if (skipButton) skipButton.classList.add("hidden");

          if (questionIndex < questions.length - 1) {
            if (nextButton) nextButton.classList.remove("hidden");
            if (finishButton) finishButton.classList.add("hidden");
          } else {
            if (finishButton) finishButton.classList.remove("hidden");
            if (nextButton) nextButton.classList.add("hidden");
          }
        } else if (isSkipped) {
          if (submitButton) submitButton.classList.remove("hidden");
          if (skipButton) skipButton.classList.remove("hidden");
          if (nextButton) nextButton.classList.add("hidden");
          if (finishButton) finishButton.classList.add("hidden");

          if (questionIndex === questions.length - 1) {
            if (finishButton) finishButton.classList.remove("hidden");
            if (submitButton) submitButton.classList.add("hidden");
          }
        } else {
          if (submitButton) submitButton.classList.remove("hidden");
          if (skipButton) skipButton.classList.remove("hidden");
          if (nextButton) nextButton.classList.add("hidden");
          if (finishButton) finishButton.classList.add("hidden");

          if (questionIndex === questions.length - 1) {
            if (finishButton) finishButton.classList.remove("hidden");
            if (submitButton) submitButton.classList.add("hidden");
          }
        }

        // Build question HTML
        quizContainer.innerHTML = `
        <div class="mb-6">
            <p class="question-text text-blue-800 mb-6">Question ${
              questionIndex + 1
            } of ${questions.length}: ${question.text}</p>
            ${
              question.image_path
                ? `<img src="/static/uploads/${question.image_path}" alt="Question image" class="mb-4 max-w-full h-auto rounded-lg">`
                : ""
            }
            <div class="space-y-4">
                ${question.options
                  .map((option, i) => {
                    const isSelected = userAnswers[questionIndex] === option;
                    const isDisabled = isAnswered && !isSkipped;

                    return `
                    <label class="block option-text p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all option-label ${
                      isDisabled ? "option-disabled" : ""
                    } ${
                      isSelected
                        ? questionStatuses[questionIndex] === "correct"
                          ? "correct-answer"
                          : "wrong-answer"
                        : ""
                    }">
                        <input type="radio" name="answer" value="${option}" class="mr-3 hidden option-input" ${
                      isDisabled ? "disabled" : ""
                    } ${isSelected ? "checked" : ""}>
                        ${String.fromCharCode(65 + i)}. ${option}
                    </label>
                `;
                  })
                  .join("")}
            </div>
        </div>
    `;

        if (isAnswered && answerFeedback) {
          answerFeedback.classList.remove("hidden");
          const wasCorrect = questionStatuses[questionIndex] === "correct";

          answerFeedback.innerHTML = `
            <p class="font-semibold ${
              wasCorrect ? "text-green-600" : "text-red-600"
            }">
                ${wasCorrect ? "✓ Correct! +1 point" : "✗ Incorrect! No points"}
            </p>
            <p class="mt-2">Correct answer: <span class="font-medium">${
              question.correct_answer
            }</span></p>
            <p class="mt-1 text-sm text-gray-600">Question ${
              questionIndex + 1
            } of ${questions.length}</p>
        `;
        }

        if (!isAnswered) {
          const optionLabels = document.querySelectorAll(".option-label");
          const optionInputs = document.querySelectorAll(".option-input");

          optionLabels.forEach((label, index) => {
            label.addEventListener("click", () => {
              if (answerSubmitted) return;

              optionLabels.forEach((l) =>
                l.classList.remove("border-blue-500", "bg-blue-50")
              );
              label.classList.add("border-blue-500", "bg-blue-50");
              optionInputs[index].checked = true;
              selectedAnswer = optionInputs[index].value;
              userAnswers[questionIndex] = selectedAnswer;
            });
          });
        }

        // Update question navigation highlights
        const questionNavigation = document.getElementById(
          "question-navigation"
        );
        if (questionNavigation) {
          const questionButtons = questionNavigation.querySelectorAll("button");
          questionButtons.forEach((btn, i) => {
            btn.classList.remove("question-status-current");
            if (i === currentQuestionIndex) {
              btn.classList.add("question-status-current");
            }
          });
        }
      }

      function updateTimer() {
        fetch("/check_time")
          .then((response) => response.json())
          .then((data) => {
            const timeMinutes = document.getElementById("time-left-minutes");
            const timeSeconds = document.getElementById("time-left-seconds");
            const timeDisplay = document.getElementById("time-display");

            if (!timeMinutes || !timeSeconds || !timeDisplay) return;

            if (data.time_up && !quizSubmitted) {
              clearInterval(timerInterval);
              forceSubmitQuiz("Time is up! Quiz submitted automatically.");
              return;
            }

            timeMinutes.textContent = String(data.time_left_minutes).padStart(
              2,
              "0"
            );
            timeSeconds.textContent = String(data.time_left_seconds).padStart(
              2,
              "0"
            );

            timeDisplay.classList.remove(
              "time-warning",
              "time-critical",
              "bg-blue-600"
            );
            if (data.time_left_minutes < 2) {
              timeDisplay.classList.add("time-critical");
            } else if (data.time_left_minutes < 5) {
              timeDisplay.classList.add("time-warning");
            } else {
              timeDisplay.classList.add("bg-blue-600");
            }
          })
          .catch((error) => console.error("Error checking time:", error));
      }

      function submitAnswer(isFinalQuestion = false) {
        if (!selectedAnswer) {
          alert("Please select an answer before submitting.");
          return;
        }

        fetch("/api/submit_answer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            answer: selectedAnswer,
            question_index: currentQuestionIndex,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              answerSubmitted = true;
              const status = data.is_correct ? "correct" : "wrong";
              questionStatuses[currentQuestionIndex] = status;
              updateQuestionStatus(currentQuestionIndex, status);

              const optionLabels = document.querySelectorAll(".option-label");
              const optionInputs = document.querySelectorAll(".option-input");

              optionLabels.forEach((label, index) => {
                const optionValue = optionInputs[index].value;

                if (optionValue === data.correct_answer) {
                  label.classList.add("correct-answer");
                } else if (optionValue === selectedAnswer && !data.is_correct) {
                  label.classList.add("wrong-answer");
                }

                optionInputs[index].disabled = true;
                label.classList.add("option-disabled");
              });

              const answerFeedback = document.getElementById("answer-feedback");
              if (answerFeedback) {
                answerFeedback.innerHTML = `
                        <p class="font-semibold ${
                          data.is_correct ? "text-green-600" : "text-red-600"
                        }">
                            ${
                              data.is_correct
                                ? "✓ Correct! +1 point"
                                : "✗ Incorrect! No points"
                            }
                        </p>
                        <p class="mt-2">Correct answer: <span class="font-medium">${
                          data.correct_answer
                        }</span></p>
                        <p class="mt-1 text-sm text-gray-600">Question ${
                          currentQuestionIndex + 1
                        } of ${questions.length}</p>
                    `;
                answerFeedback.classList.remove("hidden");
              }

              const skipButton = document.getElementById("skip-question");
              const submitButton = document.getElementById("submit-answer");
              const nextButton = document.getElementById("next-question");
              const finishButton = document.getElementById("finish-question");

              if (skipButton) skipButton.classList.add("hidden");
              if (submitButton) submitButton.classList.add("hidden");

              if (isFinalQuestion) {
                submitQuiz();
              } else {
                if (nextButton) nextButton.classList.remove("hidden");
              }
            }
          })
          .catch((error) => {
            console.error("Error submitting answer:", error);
            alert("Error submitting answer. Please try again.");
          });
      }

      function skipQuestion(isFinalQuestion = false) {
        questionStatuses[currentQuestionIndex] = "skipped";
        updateQuestionStatus(currentQuestionIndex, "skipped");

        if (isFinalQuestion) {
          submitQuiz();
        } else {
          if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            loadQuestion(questions[currentQuestionIndex]);
          } else {
            const submitButton = document.getElementById("submit-answer");
            const finishButton = document.getElementById("finish-question");
            if (submitButton) submitButton.classList.add("hidden");
            if (finishButton) finishButton.classList.remove("hidden");
          }
        }
      }

      // Enhanced submit functions
      function forceSubmitQuiz(reason) {
        if (quizSubmitted) return;
        quizSubmitted = true;

        console.log("Force submitting quiz:", reason);

        // Clear all intervals and timeouts
        clearInterval(timerInterval);
        if (autoSubmitTimeout) {
          clearTimeout(autoSubmitTimeout);
          autoSubmitTimeout = null;
        }
        if (tabWarningCountdownInterval) {
          clearInterval(tabWarningCountdownInterval);
          tabWarningCountdownInterval = null;
        }

        // Stop AI monitoring
        if (aiMonitoringActive) {
          fetch("/api/ai_monitoring/stop", { method: "POST" }).catch((error) =>
            console.error("Error stopping AI monitoring:", error)
          );
          aiMonitoringActive = false;
        }

        // Clear AI monitoring interval
        if (aiStatusCheckInterval) {
          clearInterval(aiStatusCheckInterval);
        }

        // Remove anti-cheating measures
        removeVisibilityTracking();

        // Show submission message
        const quizContainer = document.getElementById("quiz-container");
        if (quizContainer) {
          quizContainer.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-red-500 text-4xl mb-4">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-red-600 mb-4">Quiz Submitted Automatically</h2>
                    <p class="text-lg text-gray-700 mb-4">${reason}</p>
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto"></div>
                </div>
            `;
        }

        // Disable all buttons
        document.querySelectorAll("button").forEach((btn) => {
          btn.disabled = true;
          btn.classList.add("opacity-50", "cursor-not-allowed");
        });

        // Submit the quiz
        submitQuizData(reason);
      }

      function submitQuiz() {
        if (quizSubmitted) return;
        quizSubmitted = true;

        clearInterval(timerInterval);
        removeVisibilityTracking();

        // Stop AI monitoring
        if (aiMonitoringActive) {
          fetch("/api/ai_monitoring/stop", { method: "POST" }).catch((error) =>
            console.error("Error stopping AI monitoring:", error)
          );
          aiMonitoringActive = false;
        }

        // Clear AI monitoring interval
        if (aiStatusCheckInterval) {
          clearInterval(aiStatusCheckInterval);
        }

        console.log("Normal quiz submission");
        submitQuizData("Quiz completed normally");
      }

      function submitQuizData(submissionReason) {
        fetch("/api/finish_quiz", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        })
          .then((response) => {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              return response.json();
            } else {
              return response.text().then((text) => {
                throw new Error(
                  `Server returned non-JSON response: ${text.substring(
                    0,
                    100
                  )}...`
                );
              });
            }
          })
          .then((data) => {
            console.log("Quiz submission response:", data);

            // Exit fullscreen after submission
            setTimeout(() => {
              exitFullscreen();
            }, 2000);

            if (data.redirect) {
              window.location.href = data.redirect;
            } else if (data.error) {
              alert("Error submitting quiz: " + data.error);
              window.location.href = "/feedback";
            } else if (data.success) {
              setTimeout(() => {
                window.location.href = data.redirect || "/feedback";
              }, 3000);
            } else {
              setTimeout(() => {
                window.location.href = "/feedback";
              }, 3000);
            }
          })
          .catch((error) => {
            console.error("Error submitting quiz:", error);
            // Still redirect to feedback even if there's an error
            setTimeout(() => {
              window.location.href = "/feedback";
            }, 3000);
          });
      }

      // Main initialization function
      async function initializeQuiz() {
        try {
          // Step 1: Check if user is blocked
          updateLoadingMessage("Checking account status...");
          isBlocked = await checkIfBlocked();
          if (isBlocked) return;

          // Step 2: Check if quiz already attempted
          updateLoadingMessage("Verifying quiz access...");
          const alreadyAttempted = await checkQuizAttempt();
          if (alreadyAttempted) return;

          // Step 3: Enable fullscreen automatically (with better error handling)
          updateLoadingMessage("Enabling fullscreen mode...");
          try {
            await enterFullscreen();
            fullscreenEnabled = true;
            console.log("Fullscreen enabled successfully");
          } catch (err) {
            console.error("Failed to enable fullscreen:", err);
            // Show warning but continue
            showFullscreenWarning();
            // Don't treat this as a fatal error - continue with quiz
          }

          // Step 4: Initialize AI monitoring
          await initializeAIMonitoring();

          // Step 5: Load questions
          updateLoadingMessage("Loading quiz questions...");
          const questionsResponse = await fetch("/api/get_questions");
          if (!questionsResponse.ok) {
            throw new Error(
              `Failed to load questions: ${questionsResponse.status}`
            );
          }
          questions = await questionsResponse.json();

          if (questions.length === 0) {
            throw new Error("No questions available for this quiz");
          }

          // Step 6: Setup security measures
          updateLoadingMessage("Initializing security measures...");
          setupVisibilityTracking();

          // Step 7: Setup anti-cheating measures
          document.addEventListener("contextmenu", function (e) {
            e.preventDefault();
            return false;
          });

          document.addEventListener("keydown", function (e) {
            // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, Alt+Tab, etc.
            if (
              e.key === "F12" ||
              (e.ctrlKey && e.shiftKey && e.key === "I") ||
              (e.ctrlKey && e.shiftKey && e.key === "J") ||
              (e.ctrlKey && e.key === "u") ||
              (e.altKey && e.key === "Tab") ||
              (e.metaKey && e.key === "Tab") ||
              (e.ctrlKey && e.key === "c") ||
              (e.ctrlKey && e.key === "v")
            ) {
              e.preventDefault();
              if (!quizSubmitted && !isBlocked) {
                handleViolation("keyboard_shortcut");
              }
              return false;
            }
          });

          // Prevent drag and drop
          document.addEventListener("dragstart", function (e) {
            e.preventDefault();
            return false;
          });

          document.addEventListener("drop", function (e) {
            e.preventDefault();
            return false;
          });

          // Step 8: Initialize quiz UI
          updateLoadingMessage("Finalizing setup...");
          initializeQuestionNavigation();
          loadQuestion(questions[0]);

          // Step 9: Start timer
          updateTimer();
          timerInterval = setInterval(updateTimer, 1000);

          // Step 10: Show quiz content
          document.getElementById("initial-loading").style.display = "none";
          document.getElementById("quiz-content").style.display = "block";

          console.log("Quiz initialized successfully");
        } catch (error) {
          console.error("Failed to initialize quiz:", error);
          updateLoadingMessage(`Error: ${error.message}`);

          // Show error to user
          setTimeout(() => {
            alert(`Failed to start quiz: ${error.message}. Please try again.`);
            window.location.href = "{{ url_for('student.student_dashboard') }}";
          }, 2000);
        }
      }

      // Event listeners for quiz buttons
      function setupQuizEventListeners() {
        const submitButton = document.getElementById("submit-answer");
        const skipButton = document.getElementById("skip-question");
        const nextButton = document.getElementById("next-question");
        const finishButton = document.getElementById("finish-question");
        const enableFullscreenBtn =
          document.getElementById("enable-fullscreen");

        if (submitButton) {
          submitButton.addEventListener("click", () => {
            if (!selectedAnswer) {
              alert("Please select an answer before submitting.");
              return;
            }
            submitAnswer();
          });
        }

        if (skipButton) {
          skipButton.addEventListener("click", () => {
            skipQuestion();
          });
        }

        if (finishButton) {
          finishButton.addEventListener("click", () => {
            if (
              !selectedAnswer &&
              !confirm(
                "You haven't answered this question. Do you want to finish without answering?"
              )
            ) {
              return;
            }
            if (selectedAnswer) {
              submitAnswer(true);
            } else {
              skipQuestion(true);
            }
          });
        }

        if (nextButton) {
          nextButton.addEventListener("click", () => {
            if (currentQuestionIndex < questions.length - 1) {
              currentQuestionIndex++;
              loadQuestion(questions[currentQuestionIndex]);
            } else {
              const submitButton = document.getElementById("submit-answer");
              const finishButton = document.getElementById("finish-question");
              if (submitButton) submitButton.classList.add("hidden");
              if (finishButton) finishButton.classList.remove("hidden");
            }
          });
        }

        if (enableFullscreenBtn) {
          enableFullscreenBtn.addEventListener("click", async () => {
            try {
              await enterFullscreen();
              fullscreenEnabled = true;
              hideFullscreenWarning();
            } catch (err) {
              console.error("Error entering fullscreen:", err);
              alert("Please allow fullscreen mode to continue with the quiz.");
            }
          });
        }
      }

      // Fullscreen change handler
      function handleFullscreenChange() {
        if (checkFullscreen()) {
          fullscreenEnabled = true;
          hideFullscreenWarning();
        } else {
          fullscreenEnabled = false;
          if (!quizSubmitted && !isBlocked && questions.length > 0) {
            showFullscreenWarning();
            handleViolation("fullscreen_exit");
          }
        }
      }

      // Document ready
      document.addEventListener("DOMContentLoaded", function () {
        // Setup fullscreen event listeners
        document.addEventListener("fullscreenchange", handleFullscreenChange);
        document.addEventListener(
          "webkitfullscreenchange",
          handleFullscreenChange
        );
        document.addEventListener("msfullscreenchange", handleFullscreenChange);

        // Setup quiz event listeners
        setupQuizEventListeners();

        // Start quiz initialization
        initializeQuiz();

        // Add periodic blocked status check
        setInterval(async () => {
          if (!quizSubmitted && !isBlocked) {
            isBlocked = await checkIfBlocked();
          }
        }, 30000); // Check every 30 seconds
      });

      // Prevent back-forward cache
      window.onpageshow = function (event) {
        if (event.persisted) {
          window.location.reload();
        }
      };

      window.onbeforeunload = function () {
        if (!quizSubmitted && !isBlocked) {
          return "Are you sure you want to leave? Your quiz progress may be lost.";
        }
      };

      if (performance.navigation.type === 2) {
        window.location.reload();
      }
    </script>
  </body>
</html>
