<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}DSVV Quiz System{% endblock %}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        margin: 0;
        transition: all 0.3s ease;
      }

      body.dark-mode {
        background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        color: #e2e8f0;
      }

      .logo-container {
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        border-bottom-right-radius: 20px;
      }

      .dark-mode .logo-container {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      }

      .sidebar {
        width: 250px;
        background: linear-gradient(180deg, #1e40af 0%, #3b82f6 100%);
        transition: all 0.3s ease;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        position: fixed;
        top: 80px;
        bottom: 0;
        left: 0;
        overflow-y: auto;
      }

      .dark-mode .sidebar {
        background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
      }

      .sidebar.collapsed {
        width: 70px;
      }

      .main-content {
        transition: all 0.3s ease;
        width: calc(100% - 250px);
        margin-left: 250px;
        margin-top: 80px;
      }

      .dark-mode .main-content {
        background: #1a202c;
      }

      .main-content.expanded {
        width: calc(100% - 70px);
        margin-left: 70px;
        margin-top: 80px;
      }

      .nav-item {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-left: 4px solid #93c5fd;
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.15);
        border-left: 4px solid #ffffff;
      }

      .dark-mode .nav-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .dark-mode .nav-item.active {
        background: rgba(255, 255, 255, 0.1);
      }

      .card-hover {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .stats-card {
        border-left: 4px solid;
        transition: all 0.3s ease;
      }

      .stats-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      }

      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 2000;
        height: 80px;
        padding: 10px 20px;
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .dark-mode header {
        background-color: #1e293b;
        color: #e2e8f0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      header .logo-container img {
        height: 70px;
      }

      .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #ef4444;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
      }

      /* Tooltip Styles */
      .tooltip {
        position: relative;
        display: inline-block;
      }

      .tooltip .tooltip-text {
        visibility: hidden;
        width: 280px;
        background-color: #1e293b;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 16px;
        position: absolute;
        z-index: 3000;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-size: 14px;
        line-height: 1.4;
      }

      .tooltip .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #1e293b transparent transparent transparent;
      }

      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }

      .dark-mode .tooltip .tooltip-text {
        background-color: #f8fafc;
        color: #1e293b;
      }

      .dark-mode .tooltip .tooltip-text::after {
        border-color: #f8fafc transparent transparent transparent;
      }

      /* Role Badges */
      .role-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
      }

      .role-admin {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }

      .role-faculty {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
      }

      .role-coordinator {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      }

      .role-super-admin {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
      }

      /* Permission Tags */
      .permission-tag {
        display: inline-block;
        background: #e0f2fe;
        color: #0369a1;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        margin: 1px;
      }

      .dark-mode .permission-tag {
        background: #1e3a8a;
        color: #bfdbfe;
      }

      .theme-toggle {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .theme-toggle:hover {
        background: rgba(0, 0, 0, 0.1);
      }

      .dark-mode .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .profile-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .profile-detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .profile-detail-label {
        font-weight: 600;
        color: #93c5fd;
      }

      .dark-mode .profile-detail-label {
        color: #3b82f6;
      }

      .profile-detail-value {
        text-align: right;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .profile-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        color: white;
        margin: 0 auto 10px;
      }

      .avatar-admin {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }
      .avatar-faculty {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
      }
      .avatar-coordinator {
        background: linear-gradient(135deg, #10b981, #059669);
      }
      .avatar-super-admin {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 70px;
          top: 80px;
        }

        .sidebar .menu-text {
          display: none;
        }

        .main-content {
          width: calc(100% - 70px);
          margin-left: 70px;
          margin-top: 80px;
        }

        .sidebar.collapsed {
          width: 0;
          display: none;
        }

        .main-content.expanded {
          width: 100%;
          margin-left: 0;
          margin-top: 80px;
        }

        #hamburger-toggle {
          display: block;
        }

        .tooltip .tooltip-text {
          width: 200px;
          left: -80px;
          transform: none;
        }

        .tooltip .tooltip-text::after {
          left: 90px;
        }
      }

      #hamburger-toggle {
        display: none;
      }

      /* Admin Management Menu Item */
      .admin-management-item {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: 10px;
        padding-top: 10px;
      }
    </style>
    {% block extra_head %}{% endblock %}
  </head>
  <body class="flex flex-col min-h-screen">
    <!-- Header with Logo and Hamburger Menu -->
    <header
      class="bg-white shadow-md py-4 px-4 flex justify-between items-center fixed top-0 left-0 right-0 z-50 h-20"
    >
      <div class="flex items-center w-full justify-between">
        <!-- Logo in Header -->
        <div class="logo-container flex items-center">
          <img
            src="/static/images/dsvvlogo.png"
            alt="DSVV Logo"
            class="h-24 mr-3"
          />
        </div>
        <div class="flex items-center space-x-4">
          <!-- Dark/Light Mode Toggle -->
          <div class="tooltip">
            <button
              id="theme-toggle"
              class="theme-toggle text-gray-600 focus:outline-none"
              aria-label="Toggle dark mode"
            >
              <i class="fas fa-moon text-xl" id="theme-icon"></i>
            </button>
            <span class="tooltip-text" id="theme-tooltip"
              >Switch to Dark Mode</span
            >
          </div>

          <!-- Admin Notifications -->
          <div class="relative">
            <button
              id="admin-notifications-btn"
              class="text-gray-600 focus:outline-none relative"
            >
              <i class="fas fa-bell text-xl"></i>
              <span
                id="admin-notification-count"
                class="notification-badge hidden"
                >0</span
              >
            </button>
            <div
              id="admin-notifications-dropdown"
              class="absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-lg py-2 hidden z-50 max-h-96 overflow-y-auto"
            >
              <div
                class="px-4 py-2 border-b border-gray-200 flex justify-between items-center"
              >
                <h3 class="font-semibold text-gray-700">Admin Notifications</h3>
                <div class="flex space-x-2">
                  <button
                    id="mark-all-read"
                    class="text-blue-600 text-sm hover:underline text-xs"
                    title="Mark all as read"
                  >
                    <i class="fas fa-check-double"></i>
                  </button>
                  <button
                    id="clear-all-notifications"
                    class="text-red-600 text-sm hover:underline text-xs"
                    title="Clear all notifications"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <div id="admin-notifications-list" class="p-2">
                <!-- Notifications will be loaded here -->
                <div class="text-center py-4">
                  <div
                    class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"
                  ></div>
                  <p class="mt-2 text-gray-500 text-sm">
                    Loading notifications...
                  </p>
                </div>
              </div>
              <div
                class="px-4 py-2 border-t border-gray-200 text-center bg-gray-50"
              >
                <p class="text-xs text-gray-500" id="notifications-summary">
                  Loading...
                </p>
              </div>
            </div>
          </div>

          <!-- User Profile with Tooltip -->
          <div class="relative tooltip">
            <button
              id="user-menu-button"
              class="flex items-center focus:outline-none"
            >
              <div
                id="user-avatar"
                class="w-8 h-8 rounded-full flex items-center justify-center text-white font-semibold avatar-super-admin"
              >
                A
              </div>
              <span
                class="ml-2 text-gray-700 hidden md:block"
                id="username-display"
              >
                admin.computer
              </span>
              <i
                class="fas fa-chevron-down ml-1 text-gray-600 text-xs hidden md:block"
              ></i>
              <span
                id="role-badge"
                class="role-badge role-super-admin hidden md:inline-flex"
                >Super Admin</span
              >
            </button>

            <!-- Profile Tooltip -->
            <div class="tooltip-text">
              <div
                id="profile-avatar"
                class="profile-avatar avatar-super-admin"
              >
                A
              </div>
              <div class="profile-details">
                <div class="profile-detail-item">
                  <span class="profile-detail-label">Name:</span>
                  <span class="profile-detail-value" id="profile-name"
                    >Super Administrator</span
                  >
                </div>
                <div class="profile-detail-item">
                  <span class="profile-detail-label">Username:</span>
                  <span class="profile-detail-value" id="profile-username"
                    >admin.computer</span
                  >
                </div>
                <div class="profile-detail-item">
                  <span class="profile-detail-label">Role:</span>
                  <span class="profile-detail-value" id="profile-role"
                    >Super Admin</span
                  >
                </div>
                <div class="profile-detail-item">
                  <span class="profile-detail-label">Permissions:</span>
                  <span class="profile-detail-value" id="profile-permissions">
                    <div class="flex flex-wrap gap-1 mt-1">
                      <span class="permission-tag">create</span>
                      <span class="permission-tag">read</span>
                      <span class="permission-tag">update</span>
                      <span class="permission-tag">delete</span>
                      <span class="permission-tag">manage_users</span>
                    </div>
                  </span>
                </div>
                <div class="profile-detail-item">
                  <span class="profile-detail-label">Last Login:</span>
                  <span class="profile-detail-value" id="last-login-time"
                    >Loading...</span
                  >
                </div>
              </div>
            </div>

            <!-- User dropdown -->
            <div
              id="user-dropdown"
              class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 hidden z-50"
            >
              <a
                href="#"
                class="block px-4 py-2 text-gray-700 hover:bg-gray-100"
              >
                <i class="fas fa-user-circle mr-2"></i>Profile
              </a>
              <a
                href="/admin/settings"
                class="block px-4 py-2 text-gray-700 hover:bg-gray-100"
              >
                <i class="fas fa-cog mr-2"></i>Settings
              </a>
              <a
                href="/logout"
                class="block px-4 py-2 text-gray-700 hover:bg-gray-100"
              >
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Dropdown Menu (hidden by default) -->
    <nav
      id="dropdown-menu"
      class="hidden md:hidden bg-gradient-to-b from-blue-800 to-blue-600 text-white shadow-lg mt-20 fixed left-0 right-0 z-40"
    >
      <ul class="space-y-2 px-4 py-4">
        <li class="nav-item {% if request.path == '/admin' %}active{% endif %}">
          <a
            href="/admin"
            class="flex items-center p-3 rounded-lg hover:bg-blue-700"
          >
            <i class="fas fa-tachometer-alt w-6 text-center"></i>
            <span class="ml-3">Dashboard</span>
          </a>
        </li>

        <!-- Question Management - All roles -->
        <li
          class="nav-item {% if '/admin/questions' in request.path %}active{% endif %}"
        >
          <a
            href="/admin/questions/management"
            class="flex items-center p-3 text-white rounded-lg"
          >
            <i class="fas fa-book w-6 text-center"></i>
            <span class="ml-3 menu-text">Question Management</span>
          </a>
        </li>

        <!-- Quiz Management - Only for Admin and Faculty -->
        {% if session.role in ['admin', 'faculty'] %}
        <li
          class="nav-item {% if '/admin/quizzes' in request.path %}active{% endif %}"
        >
          <a
            href="/admin/quizzes"
            class="flex items-center p-3 text-white rounded-lg"
          >
            <i class="fas fa-rocket w-6 text-center"></i>
            <span class="ml-3 menu-text">Quiz Management</span>
          </a>
        </li>
        {% endif %}

        <!-- Leaderboard - Only for Admin and Faculty -->
        {% if session.role in ['admin', 'faculty'] %}
        <li
          class="nav-item {% if '/admin/leaderboard' in request.path %}active{% endif %}"
        >
          <a
            href="/admin/leaderboard"
            class="flex items-center p-3 text-white rounded-lg"
          >
            <i class="fas fa-trophy w-6 text-center"></i>
            <span class="ml-3 menu-text">Leaderboard</span>
          </a>
        </li>
        {% endif %}

        <!-- Results - All roles -->
        <li
          class="nav-item {% if '/admin/results' in request.path %}active{% endif %}"
        >
          <a
            href="/admin/results"
            class="flex items-center p-3 rounded-lg hover:bg-blue-700"
          >
            <i class="fas fa-chart-bar w-6 text-center"></i>
            <span class="ml-3">Results</span>
          </a>
        </li>

        <!-- Admin Management (Only for Super Admin) -->
        {% if session.user_type == 'super_admin' %}
        <li
          class="nav-item admin-management-item {% if '/admin/users/manage-admins' in request.path %}active{% endif %}"
          id="admin-management-menu"
        >
          <a
            href="/admin/users/manage-admins"
            class="flex items-center p-3 rounded-lg hover:bg-blue-700"
          >
            <i class="fas fa-user-shield w-6 text-center"></i>
            <span class="ml-3">Admin Users</span>
          </a>
        </li>
        {% endif %}

        <!-- User Management - Only for Admin -->
        {% if session.role == 'admin' %}
        <li
          class="nav-item {% if '/admin/users' in request.path %}active{% endif %}"
        >
          <a
            href="/admin/users"
            class="flex items-center p-3 rounded-lg hover:bg-blue-700"
          >
            <i class="fas fa-users w-6 text-center"></i>
            <span class="ml-3">User Management</span>
          </a>
        </li>
        {% endif %}

        <li class="nav-item">
          <a
            href="/admin/settings"
            class="flex items-center p-3 rounded-lg hover:bg-blue-700"
          >
            <i class="fas fa-cog w-6 text-center"></i>
            <span class="ml-3">Settings</span>
          </a>
        </li>
        <li class="nav-item">
          <a
            href="/logout"
            class="flex items-center p-3 rounded-lg hover:bg-blue-700"
          >
            <i class="fas fa-sign-out-alt w-6 text-center"></i>
            <span class="ml-3">Logout</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Sidebar Navigation -->
    <div class="sidebar h-[calc(100vh-80px)] mt-0">
      <div class="py-6">
        <ul class="space-y-2 px-4">
          <li
            class="nav-item {% if request.path == '/admin' %}active{% endif %}"
          >
            <a
              href="/admin"
              class="flex items-center p-3 text-white rounded-lg"
            >
              <i class="fas fa-tachometer-alt w-6 text-center"></i>
              <span class="ml-3 menu-text">Dashboard</span>
            </a>
          </li>

          <!-- Question Management - All roles -->
          <li
            class="nav-item {% if '/admin/questions' in request.path %}active{% endif %}"
          >
            <a
              href="/admin/questions/management"
              class="flex items-center p-3 text-white rounded-lg"
            >
              <i class="fas fa-book w-6 text-center"></i>
              <span class="ml-3 menu-text">Question Management</span>
            </a>
          </li>

          <!-- Quiz Management - Only for Admin and Faculty -->
          {% if session.role in ['admin', 'faculty'] %}
          <li
            class="nav-item {% if '/admin/quizzes' in request.path %}active{% endif %}"
          >
            <a
              href="/admin/quizzes"
              class="flex items-center p-3 text-white rounded-lg"
            >
              <i class="fas fa-rocket w-6 text-center"></i>
              <span class="ml-3 menu-text">Quiz Management</span>
            </a>
          </li>
          {% endif %}

          <!-- Leaderboard - Only for Admin and Faculty -->
          {% if session.role in ['admin', 'faculty'] %}
          <li
            class="nav-item {% if '/admin/leaderboard' in request.path %}active{% endif %}"
          >
            <a
              href="/admin/leaderboard"
              class="flex items-center p-3 text-white rounded-lg"
            >
              <i class="fas fa-trophy w-6 text-center"></i>
              <span class="ml-3 menu-text">Leaderboard</span>
            </a>
          </li>
          {% endif %}

          <!-- Results - All roles -->
          <li
            class="nav-item {% if '/admin/results' in request.path %}active{% endif %}"
          >
            <a
              href="/admin/results"
              class="flex items-center p-3 text-white rounded-lg"
            >
              <i class="fas fa-chart-bar w-6 text-center"></i>
              <span class="ml-3 menu-text">Results</span>
            </a>
          </li>

          <!-- Admin Management (Only for Super Admin) -->
          {% if session.user_type == 'super_admin' %}
          <li
            class="nav-item admin-management-item {% if '/admin/users/manage-admins' in request.path %}active{% endif %}"
            id="sidebar-admin-management"
          >
            <a
              href="/admin/users/manage-admins"
              class="flex items-center p-3 text-white rounded-lg"
            >
              <i class="fas fa-user-shield w-6 text-center"></i>
              <span class="ml-3 menu-text">Admin Users</span>
            </a>
          </li>
          {% endif %}

          <!-- User Management - Only for Admin -->
          {% if session.role == 'admin' %}
          <li
            class="nav-item {% if '/admin/users' in request.path %}active{% endif %}"
          >
            <a
              href="/admin/users"
              class="flex items-center p-3 text-white rounded-lg"
            >
              <i class="fas fa-users w-6 text-center"></i>
              <span class="ml-3 menu-text">User Management</span>
            </a>
          </li>
          {% endif %}

          <li class="nav-item">
            <a
              href="/admin/settings"
              class="flex items-center p-3 text-white rounded-lg"
            >
              <i class="fas fa-cog w-6 text-center"></i>
              <span class="ml-3 menu-text">Settings</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              href="/logout"
              class="flex items-center p-3 text-white rounded-lg"
            >
              <i class="fas fa-sign-out-alt w-6 text-center"></i>
              <span class="ml-3 menu-text">Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content min-h-[calc(100vh-80px)]">
      {% block content %}{% endblock %}
    </div>

    <!-- Common JavaScript -->
    <script>
      // Common JavaScript functions for all admin pages
      document.addEventListener("DOMContentLoaded", function () {
        // Update user info based on session
        function updateUserInfo() {
          const userType = '{{ session.get("user_type", "super_admin") }}';
          const userRole = '{{ session.get("role", "admin") }}';
          const username = '{{ session.get("username", "admin.computer") }}';
          const permissions = JSON.parse(
            '{{ session.get("permissions", ["create", "read", "update", "delete", "manage_users"]) | tojson | safe }}'
          );

          // Set role-specific styling
          const roleClass =
            userType === "super_admin" ? "super-admin" : userRole;
          const roleText =
            userType === "super_admin"
              ? "Super Admin"
              : userRole.charAt(0).toUpperCase() + userRole.slice(1);

          // Update avatar
          document.getElementById(
            "user-avatar"
          ).className = `w-8 h-8 rounded-full flex items-center justify-center text-white font-semibold avatar-${roleClass}`;
          document.getElementById("user-avatar").textContent =
            roleText.charAt(0);
          document.getElementById(
            "profile-avatar"
          ).className = `profile-avatar avatar-${roleClass}`;
          document.getElementById("profile-avatar").textContent =
            roleText.charAt(0);

          // Update role badge
          const roleBadge = document.getElementById("role-badge");
          roleBadge.className = `role-badge role-${roleClass} hidden md:inline-flex`;
          roleBadge.textContent = roleText;
          roleBadge.classList.remove("hidden");

          // Update username
          document.getElementById("username-display").textContent = username;
          document.getElementById("profile-username").textContent = username;
          document.getElementById("profile-name").textContent =
            roleText + " User";
          document.getElementById("profile-role").textContent = roleText;

          // Update permissions
          const permissionsContainer = document.getElementById(
            "profile-permissions"
          );
          permissionsContainer.innerHTML = permissions
            .map((perm) => `<span class="permission-tag">${perm}</span>`)
            .join("");

          // Hide admin management menu for non-super admins
          if (userType !== "super_admin") {
            document
              .getElementById("admin-management-menu")
              ?.classList.add("hidden");
            document
              .getElementById("sidebar-admin-management")
              ?.classList.add("hidden");
          }

          // Hide menu items based on role (for mobile dropdown)
          if (userRole === "coordinator") {
            // Coordinators can't access quiz management or user management
            document
              .querySelectorAll('[href*="/admin/quizzes"]')
              .forEach((el) => (el.parentElement.style.display = "none"));
            document
              .querySelectorAll('[href*="/admin/users"]')
              .forEach((el) => (el.parentElement.style.display = "none"));
            document
              .querySelectorAll('[href*="/admin/leaderboard"]')
              .forEach((el) => (el.parentElement.style.display = "none"));
          }

          if (userRole === "faculty") {
            // Faculty can't access user management
            document
              .querySelectorAll('[href*="/admin/users/manage-admins"]')
              .forEach((el) => (el.parentElement.style.display = "none"));
            document
              .querySelectorAll('[href*="/admin/users"]')
              .forEach((el) => (el.parentElement.style.display = "none"));
          }
        }

        // Dark/Light Mode Toggle
        const themeToggle = document.getElementById("theme-toggle");
        const themeIcon = document.getElementById("theme-icon");
        const themeTooltip = document.getElementById("theme-tooltip");
        const body = document.body;

        // Check for saved theme preference or prefer color scheme
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;

        if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
          enableDarkMode();
        } else {
          enableLightMode();
        }

        themeToggle.addEventListener("click", function () {
          if (body.classList.contains("dark-mode")) {
            enableLightMode();
          } else {
            enableDarkMode();
          }
        });

        function enableDarkMode() {
          body.classList.add("dark-mode");
          themeIcon.classList.remove("fa-moon");
          themeIcon.classList.add("fa-sun");
          themeTooltip.textContent = "Switch to Light Mode";
          localStorage.setItem("theme", "dark");
        }

        function enableLightMode() {
          body.classList.remove("dark-mode");
          themeIcon.classList.remove("fa-sun");
          themeIcon.classList.add("fa-moon");
          themeTooltip.textContent = "Switch to Dark Mode";
          localStorage.setItem("theme", "light");
        }

        // Update last login time in profile tooltip
        function updateLastLoginTime() {
          const lastLoginElement = document.getElementById("last-login-time");
          const now = new Date();
          const options = {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          };
          lastLoginElement.textContent = now.toLocaleDateString(
            "en-US",
            options
          );
        }

        updateLastLoginTime();
        updateUserInfo();

        // Toggle user dropdown
        document
          .getElementById("user-menu-button")
          .addEventListener("click", function () {
            document.getElementById("user-dropdown").classList.toggle("hidden");
          });

        // Close dropdown when clicking outside
        document.addEventListener("click", function (event) {
          const userMenu = document.getElementById("user-menu-button");
          const dropdown = document.getElementById("user-dropdown");
          if (
            !userMenu.contains(event.target) &&
            !dropdown.contains(event.target)
          ) {
            dropdown.classList.add("hidden");
          }
        });

        // Set active navigation item
        const currentPage = window.location.pathname;
        const navItems = document.querySelectorAll(".nav-item");

        navItems.forEach((item) => {
          const link = item.querySelector("a");
          if (link.getAttribute("href") === currentPage) {
            item.classList.add("active");
          } else {
            item.classList.remove("active");
          }
        });

        // Hamburger Menu Toggle
        document
          .getElementById("hamburger-toggle")
          .addEventListener("click", function () {
            const menu = document.getElementById("dropdown-menu");
            menu.classList.toggle("hidden");
          });

        // Close menu when clicking outside
        document.addEventListener("click", function (event) {
          const toggle = document.getElementById("hamburger-toggle");
          const menu = document.getElementById("dropdown-menu");
          if (!toggle.contains(event.target) && !menu.contains(event.target)) {
            menu.classList.add("hidden");
          }
        });

        // Admin notifications functionality
        const adminNotificationsBtn = document.getElementById(
          "admin-notifications-btn"
        );
        const adminNotificationsDropdown = document.getElementById(
          "admin-notifications-dropdown"
        );
        const adminNotificationCount = document.getElementById(
          "admin-notification-count"
        );
        const adminNotificationsList = document.getElementById(
          "admin-notifications-list"
        );
        const markAllReadBtn = document.getElementById("mark-all-read");
        const clearAllNotificationsBtn = document.getElementById(
          "clear-all-notifications"
        );
        const notificationsSummary = document.getElementById(
          "notifications-summary"
        );

        function loadAdminNotifications() {
          fetch("/api/admin_notifications")
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              if (data.success) {
                const notifications = data.notifications;
                const unreadCount = notifications.filter((n) => !n.read).length;
                const totalCount = notifications.length;

                // Update notification count
                if (unreadCount > 0) {
                  adminNotificationCount.textContent = unreadCount;
                  adminNotificationCount.classList.remove("hidden");
                } else {
                  adminNotificationCount.classList.add("hidden");
                }

                // Update notifications list
                if (notifications.length > 0) {
                  adminNotificationsList.innerHTML = notifications
                    .map(
                      (notification) => `
                    <div class="p-3 border-b border-gray-100 ${
                      notification.read
                        ? ""
                        : "bg-blue-50 border-l-4 border-blue-500"
                    } notification-item" data-id="${notification._id}">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-sm font-medium ${
                              notification.read
                                ? "text-gray-700"
                                : "text-blue-700"
                            }">
                                ${notification.title}
                            </span>
                            <div class="flex space-x-1">
                                ${
                                  !notification.read
                                    ? `
                                    <button class="mark-single-read text-green-600 hover:text-green-800 text-xs" title="Mark as read" data-id="${notification._id}">
                                        <i class="fas fa-check"></i>
                                    </button>
                                `
                                    : ""
                                }
                                <button class="delete-single-notification text-red-600 hover:text-red-800 text-xs" title="Delete" data-id="${
                                  notification._id
                                }">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">${
                          notification.message
                        }</p>
                        <div class="flex justify-between items-center text-xs text-gray-400">
                            <span>${new Date(
                              notification.timestamp
                            ).toLocaleDateString()} ${new Date(
                        notification.timestamp
                      ).toLocaleTimeString()}</span>
                            ${
                              notification.course
                                ? `<span>${notification.course} Sem ${notification.semester}</span>`
                                : ""
                            }
                        </div>
                    </div>
                `
                    )
                    .join("");
                } else {
                  adminNotificationsList.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <i class="fas fa-bell-slash text-2xl mb-2"></i>
                        <p>No notifications</p>
                        <p class="text-sm mt-1">You're all caught up!</p>
                    </div>
                `;
                }

                // Update summary
                notificationsSummary.textContent = `${unreadCount} unread â€¢ ${totalCount} total`;
              } else {
                console.error("Error loading notifications:", data.error);
                adminNotificationsList.innerHTML = `
                <div class="p-4 text-center text-red-500">
                    <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                    <p>Error loading notifications</p>
                </div>
            `;
              }
            })
            .catch((error) => {
              console.error("Error loading notifications:", error);
              adminNotificationsList.innerHTML = `
            <div class="p-4 text-center text-red-500">
                <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                <p>Failed to load notifications</p>
                <p class="text-sm mt-1">Please check your connection</p>
            </div>
        `;
            });
        }

        // Load notifications initially
        loadAdminNotifications();

        // Toggle notifications dropdown
        adminNotificationsBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          adminNotificationsDropdown.classList.toggle("hidden");
          // Refresh notifications when dropdown is opened
          if (!adminNotificationsDropdown.classList.contains("hidden")) {
            loadAdminNotifications();
          }
        });

        // Mark all as read
        markAllReadBtn.addEventListener("click", function () {
          fetch("/api/admin_notifications/read", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                loadAdminNotifications();
                // Show success message
                showNotification("All notifications marked as read", "success");
              } else {
                showNotification(
                  "Error marking notifications as read",
                  "error"
                );
              }
            })
            .catch((error) => {
              console.error("Error marking notifications as read:", error);
              showNotification("Failed to mark notifications as read", "error");
            });
        });

        // Clear all notifications
        clearAllNotificationsBtn.addEventListener("click", function () {
          if (
            confirm(
              "Are you sure you want to clear all notifications? This action cannot be undone."
            )
          ) {
            fetch("/api/admin_notifications/clear", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  loadAdminNotifications();
                  // Show success message
                  showNotification("All notifications cleared", "success");
                } else {
                  showNotification("Error clearing notifications", "error");
                }
              })
              .catch((error) => {
                console.error("Error clearing notifications:", error);
                showNotification("Failed to clear notifications", "error");
              });
          }
        });

        // Event delegation for single notification actions
        adminNotificationsList.addEventListener("click", function (e) {
          const target = e.target;

          // Mark single as read
          if (target.closest(".mark-single-read")) {
            const button = target.closest(".mark-single-read");
            const notificationId = button.getAttribute("data-id");

            fetch(`/api/admin_notifications/${notificationId}/read`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  loadAdminNotifications();
                  showNotification("Notification marked as read", "success");
                } else {
                  showNotification(
                    "Error marking notification as read",
                    "error"
                  );
                }
              })
              .catch((error) => {
                console.error("Error marking notification as read:", error);
                showNotification(
                  "Failed to mark notification as read",
                  "error"
                );
              });
          }

          // Delete single notification
          if (target.closest(".delete-single-notification")) {
            const button = target.closest(".delete-single-notification");
            const notificationId = button.getAttribute("data-id");

            if (confirm("Are you sure you want to delete this notification?")) {
              fetch(`/api/admin_notifications/${notificationId}`, {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                },
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.success) {
                    loadAdminNotifications();
                    showNotification("Notification deleted", "success");
                  } else {
                    showNotification("Error deleting notification", "error");
                  }
                })
                .catch((error) => {
                  console.error("Error deleting notification:", error);
                  showNotification("Failed to delete notification", "error");
                });
            }
          }
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", function (e) {
          if (
            !adminNotificationsDropdown.contains(e.target) &&
            !adminNotificationsBtn.contains(e.target)
          ) {
            adminNotificationsDropdown.classList.add("hidden");
          }
        });

        // Poll for new notifications every 30 seconds
        setInterval(loadAdminNotifications, 30000);

        // Check if page was restored from bfcache
        if (performance.navigation.type === 2) {
          window.location.reload();
        }
      });
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
